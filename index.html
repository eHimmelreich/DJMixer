<!DOCTYPE html>
<html>
<title>YouTube Mixer - https://developers.google.com/youtube/iframe_api_reference</title>

<head>
  <link href="//cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <style>
    @import url(//fonts.googleapis.com/css?family=Roboto:400,300);
    @import url(//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css);

    body {
      padding: 70px 0px;
    } 

    .mixer {
      display: flex;
      flex-direction: row;
      text-align: center;

    }

    .players {
      width: 100%;
      display: flex;
      flex-direction: row;
      text-align: center;
    }

    .controls {
      align-items: center;
      text-align: center;
    }

    .panelRight {
      top: 0;
      right: 0;
      position: absolute;
      flex-direction: column;
    }

    .panelLeft {
      top: 0;
      left: 0;
      position: absolute;
      flex-direction: column;
    }
  </style>

</head>

<body>

  <!-- 1. The <iframe> (and video player) will replace this <div> tag. -->
  <div class="container-fluid">

    <div class="row" id="players">
      <div class="input-group mb-3">
        <input id="playlistLeft" type="text" class="form-control" name="playlistLeft" placeholder="Playlist URL" value="">
        <button class="btn btn-outline-secondary" type="button" id="load-playlist-left" onclick="loadYouTubeAPI()">Load</button>
      </div>

      <div class="col s6">
        <div id="panelLeft">
          <!-- <div class="input-group mb-3">
            <input id="playlistLeft" type="text" class="form-control" name="playlistLeft" placeholder="Playlist URL" value="">
            <button class="btn btn-outline-secondary" type="button" id="load-playlist-left" onclick="loadPlaylist('playerLeft')">Load</button>
          </div> -->

          <div id="playerLeft"></div>

          <div id="controlsLeft" class="controls">
            <input type="button" id="play-left" class="btn btn-outline-secondary" value="Play" onclick="playVideo('playerLeft')"/>
            <input type="button" id="pause-left" class="btn btn-outline-secondary" value="Pause" onclick="pauseVideo('playerLeft')"/>
          </div>  
        </div>
      </div>
      <div class="col s6">
        <div id="panelRight">
          <!-- <div class="input-group mb-3">
            <input id="playlistRight" type="text" class="form-control" name="playlistRight" placeholder="Playlist URL" value="">
            <button class="btn btn-outline-secondary" type="button" id="load-playlist-right" onclick="loadPlaylist('playerRight')">Load</button>
          </div> -->
        
          <div id="playerRight"></div>

          <div id="controlsRight" class="controls">
            <input type="button" id="play-right" class="btn btn-outline-secondary" value="Play" onclick="playVideo('playerRight')"/>
            <input type="button" id="pause-right" class="btn btn-outline-secondary" value="Pause" onclick="pauseVideo('playerRight')"/>
          </div>    
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-center align-items-center align-content-around">
      <input type="button" id="fade-left" class="btn btn-outline-secondary" value="<= Fade Left"/>
      <div class="range">
        <input type="range" class="form-range" id="myRange"  name="range" min="0" max="100" value="0" onchange="range.value=value">
        <input id="range" type="hidden"/>
      </div>
      <input type="button" id="fade-right" class="btn btn-outline-secondary" value="Fade Right =>"/>
      <p><span id="slider"></span></p>
    </div>

  </div>

  <script>

    var playerLeft;
    var playerRight;

    var readyPlayersCount = 0

    function loadYouTubeAPI() {
      // 2. This code loads the IFrame Player API code asynchronously.
      var tag = document.createElement('script');

      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);  
    }
    // 3. This function creates an <iframe> (and YouTube player)
    //    after the API code downloads.

    function onYouTubeIframeAPIReady() {
      playlistID = document.getElementById('playlistLeft').value;

      //https://www.youtube.com/playlist?list=PLmemCpSltdCHDk699YqlQq9F4B3ExWgA_
      if (playlistID.startsWith('https://') && playlistID.indexOf('list=') != -1) {
        const params = new URLSearchParams(playlistID.split('?')[1]);
        console.log(params.toString())
        playlistID = params.get('list')
      }

      initAllPlayers(playlistID);
    }

    function initAllPlayers(playlistID){

      playerLeft = undefined;
      playerRight = undefined;
      
      playerLeft = initPlayer('playerLeft', playlistID);

      // Delay loading as google is blocking requests
      setTimeout(function () {
        playerRight = initPlayer('playerRight', playlistID);
      }, 1000);
    }

    function initPlayer(playerId, playlistID) {

      if (playlistID.startsWith('PL') == false) {
        playlistID = 'PL' + playlistID
      }

      let p = new YT.Player(playerId, {
        //height: '390',
        width: '100%',
        playerVars: {
          playsinline: 1,  //inline on iOS
          autoplay: 0,
          controls: 1,
          showinfo: 0,
          listType: 'playlist',
          list: playlistID,
          enablejsapi: 1,
          // 'modestbranding': 0,
          // 'loop': 1,
          fs: 0, //full screen
          rel: 0, //do not show related videos
        },
        events: {
          'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange
        }
      });
      return p;
    }

    // 4. The API will call this function when the video player is ready.
    function onPlayerReady(event) {

      readyPlayersCount += 1;

      if (readyPlayersCount == 2) {
        //event.target.playVideo();

        //playlist = ['qlmOSPnlmww', 'MmeiSgwaaJE']
        //playerLeft.loadPlaylist(playlist,0, 0)             
        //playerRight.loadPlaylist(playlist,0, 0)             
        //event.target.mute();
        console.log('onPlayerReady');
        console.log(event);

        balanceVolume();
      } else {
        console.log('Skipping first player...');
      }
    }

    // 5. The API calls this function when the player's state changes.
    //    The function indicates that when playing a video (state=1),
    //    the player should play for six seconds and then stop.
    var done = false;
    function onPlayerStateChange(event) {

      console.log('onPlayerStateChange');
      console.log(event);
      if (event.data == -1  && !done) { // when started to play a video (state=1)
        event.target.nextVideo()
        done = true;
      }

      if (event.data == YT.PlayerState.PLAYING && !done) { // when started to play a video (state=1)
        //setTimeout(stopVideo, 6000); - stop after 6 seconds of playing
        done = true;
      }
    }

    function playVideo(playerID) {
      if (playerID == 'playerLeft') {
        playerLeft.playVideo();
      } else if(playerID == 'playerRight') {
        playerRight.playVideo();
      }
    }

    function pauseVideo(playerID) {
      if (playerID == 'playerLeft') {
        playerLeft.pauseVideo();
      } else if(playerID == 'playerRight') {
        playerRight.pauseVideo();
      }
    }

    function stopVideo() {
      if (playerID == 'playerLeft') {
        playerLeft.stopVideo();
      } else if(playerID == 'playerRight') {
        playerRight.stopVideo();
      }
    }

    function setVolume(volume) {
      playerLeft.setVolume(100 - volume)
      playerRight.setVolume(volume)
    }

    /*** Slider ****************************************/
    var slider = document.getElementById("myRange");

    // Update the current slider value (each time you drag the slider handle)
    slider.oninput = function () {
      setVolume(this.value)
    }

    function balanceVolume() {
      slider.value = 0
      setVolume(0)
    }

    function loadPlaylist(playerID, value){
        playlistURL = document.getElementById('playlistLeft');
        try {
          playerLeft.loadPlaylist(playlistURL.value,0, 0);
        } catch(e) {
          console.log(e)
        }
        try {
          playerRight.loadPlaylist(playlistURL.value,0, 0);
        }catch(e) {
          console.log(e)
        }
        //initAllPlayers(playlistURL.value)
    }

  </script>
</body>

</html>
