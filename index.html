<!DOCTYPE html>
<html>
<title>YouTube Mixer</title>
<!-- title>https://developers.google.com/youtube/iframe_api_reference</title -->

<head>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    @import url(https://fonts.googleapis.com/css?family=Roboto:400,300);
    @import url(https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css);

    body {
      padding: 70px 70px;
      width: 99%;
    } 

    .mixer {
      display: flex;
      flex-direction: row;
      text-align: center;

    }

    .players {
      width: 100%;
      display: flex;
      flex-direction: row;
      text-align: center;
    }

    .controls {
      align-items: center;
      text-align: center;
    }

    .panelRight {
      top: 0;
      right: 0;
      position: absolute;
      flex-direction: column;
    }

    .panelLeft {
      top: 0;
      left: 0;
      position: absolute;
      flex-direction: column;
    }

    .range {
      width: 30%;
    }

  </style>

</head>

<body>

  <!-- 1. The <iframe> (and video player) will replace this <div> tag. -->
  <div class="container-fluid">

    <div class="row justify-content-center">
      <div class="col-6">
        <div class="input-group mb-3">
          <input id="playlist" type="text" class="form-control" name="playlist" placeholder="Inset Playlist URL here" value="">
          <button class="btn btn-primary" type="button" id="load-playlist-left" onclick="loadYouTubeAPI()" data-bs-toggle="collapse" data-bs-target="#collapseExample">Load</button>
        </div>
      </div>
    </div>


    <div class="collapse" id="collapseExample">
      <div class="row" id="players">

        <div class="col s6">
          <div id="panelLeft">

            <div id="playerLeft"></div>

            <div id="controlsLeft" class="controls">
              <input type="button" id="play-left" class="btn btn-outline-secondary" value="Play" onclick="playVideo('playerLeft')"/>
              <input type="button" id="pause-left" class="btn btn-outline-secondary" value="Pause" onclick="pauseVideo('playerLeft')"/>
            </div>  

          </div>
        </div>
        <div class="col s6">
          <div id="panelRight">
          
            <div id="playerRight"></div>

            <div id="controlsRight" class="controls">
              <input type="button" id="play-right" class="btn btn-outline-secondary" value="Play" onclick="playVideo('playerRight')"/>
              <input type="button" id="pause-right" class="btn btn-outline-secondary" value="Pause" onclick="pauseVideo('playerRight')"/>
            </div>
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-center align-items-center align-content-around">
        <!-- <input type="button" id="fade-left" class="btn btn-outline-secondary" value="<= Fade Left"/> -->
        <div class="range">
          <input type="range" class="form-range" id="myRange"  name="range" min="0" max="100" value="0" onchange="range.value=value">
          <input id="range" type="hidden"/>
        </div>
        <!-- <input type="button" id="fade-right" class="btn btn-outline-secondary" value="Fade Right =>"/> -->
        <p><span id="slider"></span></p>
      </div>

    </div>




    <textarea class="form-control" id="console" readonly rows="3"></textarea>

  </div>

  <script>

    var playerLeft;
    var playerRight;

    var readyPlayersCount = 0

    function unhideDOM() {

    }

    function loadYouTubeAPI() {
      // 2. This code loads the IFrame Player API code asynchronously.
      var tag = document.createElement('script');

      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);  
    }
    // 3. This function creates an <iframe> (and YouTube player)
    //    after the API code downloads.

    function onYouTubeIframeAPIReady() {
      playlistID = document.getElementById('playlist').value;

      //https://www.youtube.com/playlist?list=PLmemCpSltdCHDk699YqlQq9F4B3ExWgA_
      if (playlistID.startsWith('https://') && playlistID.indexOf('list=') != -1) {
        const params = new URLSearchParams(playlistID.split('?')[1]);
        console.log(params.toString())
        playlistID = params.get('list')
      }

      initAllPlayers(playlistID);
    }

    function initAllPlayers(playlistID){

      playerLeft = undefined;
      playerRight = undefined;
      
      playerLeft = initPlayer('playerLeft', playlistID);

      // Delay loading as google is blocking requests
      setTimeout(function () {
        playerRight = initPlayer('playerRight', playlistID);
      }, 1000);
    }

    function initPlayer(playerId, playlistID) {

      if (playlistID.startsWith('PL') == false) {
        playlistID = 'PL' + playlistID
      }

      let p = new YT.Player(playerId, {
        //height: '390',
        width: '100%',
        playerVars: {
          playsinline: 1,  //inline on iOS
          autoplay: 0,
          controls: 1,
          showinfo: 0,
          listType: 'playlist',
          list: playlistID,
          enablejsapi: 1,
          // 'modestbranding': 0,
          // 'loop': 1,
          fs: 0, //full screen
          rel: 0, //do not show related videos
        },
        events: {
          'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange,
          'onError': onPlayerError,
        }
      });
      return p;
    }

    // 2 – The request contains an invalid parameter value. For example, this error occurs if you specify a video ID that does not have 11 characters, or if the video ID contains invalid characters, such as exclamation points or asterisks.
    // 5 – The requested content cannot be played in an HTML5 player or another error related to the HTML5 player has occurred.
    // 100 – The video requested was not found. This error occurs when a video has been removed (for any reason) or has been marked as private.
    // 101 – The owner of the requested video does not allow it to be played in embedded players.
    // 150 – This error is the same as 101. It's just a 101 error in disguise!

    function onPlayerError(event) {
      let msg = ''
      switch(event.data) {
        case 2:
          msg = 'The request contains an invalid parameter value';
          break;
        case 5:
          msg = 'The video cannot be played in an HTML5 player';
          break;
        case 100:
          msg = 'The video requested was not found or has been marked as private';
          break;
        case 101:
          msg = 'The owner of the requested video does not allow it to be played in embedded players.';
          break;
        case 150:
          msg = 'The owner of the requested video does not allow it to be played in embedded players.';
          break;
        default:
          msg = 'Unknown error...';
          break;
      }
      log('Player Error: '+ msg)
    }

    // 4. The API will call this function when the video player is ready.
    function onPlayerReady(event) {

      readyPlayersCount += 1;

      if (readyPlayersCount == 2) {
        //event.target.playVideo();

        //playlist = ['qlmOSPnlmww', 'MmeiSgwaaJE']
        //playerLeft.loadPlaylist(playlist,0, 0)             
        //playerRight.loadPlaylist(playlist,0, 0)             
        //event.target.mute();
        console.log('onPlayerReady');
        console.log(event);

        balanceVolume();
      } else {
        console.log('Skipping first player...');
      }
    }

    // 5. The API calls this function when the player's state changes.
    //    The function indicates that when playing a video (state=1),
    //    the player should play for six seconds and then stop.

    // -1 – unstarted ----
    // 0 – ended - YT.PlayerState.ENDED
    // 1 – playing - YT.PlayerState.PLAYING
    // 2 – paused - YT.PlayerState.PAUSED
    // 3 – buffering - YT.PlayerState.BUFFERING
    // 5 – video cued - YT.PlayerState.CUED


    var done = false;
    function onPlayerStateChange(event) {

      console.log('onPlayerStateChange');

      // if (event.data == -1  && !done) { // when started to play a video (state=1)
      //   //event.target.nextVideo()
      //   log('Video is unavailable...', event)
      //   done = true;
      // }

      if (event.data == YT.PlayerState.PLAYING && !done) { // when started to play a video (state=1)
        //setTimeout(stopVideo, 6000); - stop after 6 seconds of playing
        done = true;
      }
    }

    function playVideo(playerID) {
      if (playerID == 'playerLeft') {
        playerLeft.playVideo();
      } else if(playerID == 'playerRight') {
        playerRight.playVideo();
      }
    }

    function pauseVideo(playerID) {
      if (playerID == 'playerLeft') {
        playerLeft.pauseVideo();
      } else if(playerID == 'playerRight') {
        playerRight.pauseVideo();
      }
    }

    function stopVideo() {
      if (playerID == 'playerLeft') {
        playerLeft.stopVideo();
      } else if(playerID == 'playerRight') {
        playerRight.stopVideo();
      }
    }

    function setVolume(volume) {
      playerLeft.setVolume(100 - volume)
      playerRight.setVolume(volume)
    }

    /*** Slider ****************************************/
    var slider = document.getElementById("myRange");

    // Update the current slider value (each time you drag the slider handle)
    slider.oninput = function () {
      setVolume(this.value)
    }

    function balanceVolume() {
      slider.value = 0
      setVolume(0)
    }

    function loadPlaylist(playerID, value){
        playlistURL = document.getElementById('playlist');
        try {
          playerLeft.loadPlaylist(playlistURL.value,0, 0);
        } catch(e) {
          console.log(e)
        }
        try {
          playerRight.loadPlaylist(playlistURL.value,0, 0);
        }catch(e) {
          console.log(e)
        }
        //initAllPlayers(playlistURL.value)
    }

    function log(text){
      textArea = document.getElementById('console')
      textArea.value += '\n' + text;
    }

  </script>
</body>

</html>
